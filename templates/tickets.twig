{% extends 'base.twig' %}
{% block content %}
<div style="max-width:1440px; margin:0 auto; padding:3rem 2rem;">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; margin-bottom:1.5rem;">
    <h1 style="font-size:clamp(2rem,4vw,2.5rem);">Ticket Management</h1>
    <details>
      <summary style="cursor:pointer; padding:1rem 1.25rem; background:var(--primary-grad); border:1px solid var(--border); border-radius:12px; font-weight:700;">+ Create Ticket</summary>
      <div style="margin-top:1rem; background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:1rem;">
        <form method="post" action="/tickets/create">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div style="margin-bottom:1rem;">
            <label for="title" style="display:block; margin-bottom:.25rem; color:var(--text-secondary); font-weight:600;">Title *</label>
            <input id="title" name="title" required maxlength="100" style="width:100%; padding:.75rem; background:var(--glass); color:var(--text-primary); border:2px solid var(--border); border-radius:10px;">
          </div>

          <div style="margin-bottom:1rem;">
            <label for="description" style="display:block; margin-bottom:.25rem; color:var(--text-secondary); font-weight:600;">Description</label>
            <textarea id="description" name="description" maxlength="500" rows="4" style="width:100%; padding:.75rem; background:var(--glass); color:var(--text-primary); border:2px solid var(--border); border-radius:10px;"></textarea>
          </div>

          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin-bottom:1rem;">
            <div>
              <label for="status" style="display:block; margin-bottom:.25rem; color:var(--text-secondary); font-weight:600;">Status *</label>
              <select id="status" name="status" required style="width:100%; padding:.75rem; background:var(--bg-card); border:2px solid var(--border); border-radius:10px; color:var(--text-primary); appearance:none;">
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div>
              <label for="priority" style="display:block; margin-bottom:.25rem; color:var(--text-secondary); font-weight:600;">Priority</label>
              <select id="priority" name="priority" style="width:100%; padding:.75rem; background:var(--bg-card); border:2px solid var(--border); border-radius:10px; color:var(--text-primary); appearance:none;">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>

          <button style="padding:.875rem 1.25rem; background:var(--primary-grad); border:1px solid var(--border); color:var(--text-primary); border-radius:10px; font-weight:700;">Create Ticket</button>
        </form>
      </div>
    </details>
  </div>

  {% if tickets is empty %}
    <div style="background:var(--bg-card); border:2px dashed var(--border); border-radius:20px; padding:4rem 2rem; text-align:center;">
      <div style="font-size:4rem; margin-bottom:1rem;">ðŸŽ«</div>
      <h3 style="font-size:1.5rem; margin-bottom:.5rem;">No tickets yet</h3>
      <p style="color:var(--text-secondary);">Create your first ticket to get started</p>
    </div>
  {% else %}
    <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:1rem;">
      {% for t in tickets %}
        {% set status = {
          'open':   {'bg':'rgba(16,185,129,.12)','border':'#10b981','text':'#10b981'},
          'in_progress': {'bg':'rgba(245,158,11,.12)','border':'#f59e0b','text':'#f59e0b'},
          'closed': {'bg':'rgba(139,148,158,.12)','border':'#94a3b8','text':'#94a3b8'}
        }[t.status]|default({'bg':'rgba(52,211,153,.12)','border':'var(--primary)','text':'var(--primary)'}) %}

        <article style="background:var(--bg-card); border:1px solid var(--border); border-radius:20px; padding:1.25rem; box-shadow:0 8px 24px var(--shadow);">
          <div style="display:inline-block; padding:.35rem .6rem; background:{{ status.bg }}; border:1px solid {{ status.border }}; color:{{ status.text }}; border-radius:8px; font-size:.75rem; font-weight:700; letter-spacing:.4px; text-transform:uppercase; margin-bottom:.75rem;">
            {{ t.status == 'in_progress' ? 'In Progress' : t.status|capitalize }}
          </div>

          <h3 style="margin:.25rem 0 .5rem; font-size:1.2rem;">{{ t.title }}</h3>
          {% if t.description %}
            <p style="color:var(--text-secondary); font-size:.95rem; margin-bottom:.75rem;">
              {{ t.description|length > 140 ? t.description|slice(0,140) ~ 'â€¦' : t.description }}
            </p>
          {% endif %}

          {% if t.priority %}
            <div style="display:inline-flex; gap:.5rem; align-items:center; color:var(--text-secondary); font-size:.85rem; margin-bottom:.75rem;">
              <span>Priority:</span>
              <span style="padding:.15rem .5rem; background:var(--glass); border:1px solid var(--border); border-radius:6px; text-transform:capitalize; color:var(--text-primary);">{{ t.priority }}</span>
            </div>
          {% endif %}

          <div style="display:flex; gap:.5rem; padding-top:.75rem; border-top:1px solid var(--border); margin-top:.5rem;">
            <!-- Edit -->
            <details style="flex:1;">
              <summary style="cursor:pointer; padding:.6rem; background:color-mix(in srgb, var(--secondary) 12%, transparent); color:var(--secondary); border:1px solid color-mix(in srgb, var(--secondary) 40%, var(--border)); border-radius:8px; font-weight:700; text-align:center;">Edit</summary>
              <div style="margin-top:.75rem;">
                <form method="post" action="/tickets/update">
                  <input type="hidden" name="csrf" value="{{ csrf }}">
                  <input type="hidden" name="id" value="{{ t.id }}">
                  <div style="margin-bottom:.5rem;">
                    <label class="sr-only" for="title-{{ t.id }}">Title</label>
                    <input id="title-{{ t.id }}" name="title" required maxlength="100" value="{{ t.title }}" style="width:100%; padding:.6rem; background:var(--glass); color:var(--text-primary); border:2px solid var(--border); border-radius:8px;">
                  </div>
                  <div style="margin-bottom:.5rem;">
                    <label class="sr-only" for="desc-{{ t.id }}">Description</label>
                    <textarea id="desc-{{ t.id }}" name="description" maxlength="500" rows="3" style="width:100%; padding:.6rem; background:var(--glass); color:var(--text-primary); border:2px solid var(--border); border-radius:8px;">{{ t.description }}</textarea>
                  </div>
                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem; margin-bottom:.5rem;">
                    <select name="status" required style="padding:.6rem; background:var(--bg-card); color:var(--text-primary); border:2px solid var(--border); border-radius:8px;">
                      <option value="open" {{ t.status=='open' ? 'selected' }}>Open</option>
                      <option value="in_progress" {{ t.status=='in_progress' ? 'selected' }}>In Progress</option>
                      <option value="closed" {{ t.status=='closed' ? 'selected' }}>Closed</option>
                    </select>
                    <select name="priority" style="padding:.6rem; background:var(--bg-card); color:var(--text-primary); border:2px solid var(--border); border-radius:8px;">
                      <option value="low" {{ t.priority=='low' ? 'selected' }}>Low</option>
                      <option value="medium" {{ t.priority=='medium' ? 'selected' }}>Medium</option>
                      <option value="high" {{ t.priority=='high' ? 'selected' }}>High</option>
                    </select>
                  </div>
                  <button style="padding:.6rem 1rem; background:var(--primary-grad); border:1px solid var(--border); color:var(--text-primary); border-radius:8px; font-weight:700;">Save</button>
                </form>
              </div>
            </details>

            <!-- Delete -->
            <form method="post" action="/tickets/delete" style="flex:1; display:flex;">
              <input type="hidden" name="csrf" value="{{ csrf }}">
              <input type="hidden" name="id" value="{{ t.id }}">
              <button style="flex:1; padding:.6rem; background:color-mix(in srgb, var(--danger) 12%, transparent); color:var(--danger); border:1px solid color-mix(in srgb, var(--danger) 40%, var(--border)); border-radius:8px; font-weight:700;">Delete</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}
